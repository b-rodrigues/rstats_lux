---
date: 2017-07-07
title: "Mapping unemployment in Luxembourg"
author: Bruno Rodrigues
image : "img/unemp_lux.png"
showonlyimage : false
categories: ["R"]
tags: ["R"]
weight : 1
---

In this blog post, I show various ways to create maps using R. You'll need to install a lot of
packages and download two data sets; the unemployment rate in Luxembourg as well as a shapefile.

To get the unemployment rate in Luxembourg, you can take a look at our [previous blog post](http://rdata.lu/portfolio/2017-04-21-scraping-data-from-statec-s-public-tables/)
and simply run the following lines:

```{r, eval=FALSE}
library(rvest)
library(dplyr)
library(purrr)
library(janitor)
library(tidyr)

page_unemp <- read_html("http://www.statistiques.public.lu/stat/TableViewer/tableViewHTML.aspx?ReportId=12950&IF_Language=eng&MainTheme=2&FldrName=3&RFPath=91")

data_raw <- page_unemp %>%
  html_nodes(".b2020-datatable") %>% .[[1]] %>% html_table(fill = TRUE)

colnames(data_raw) <- data_raw[1, ]

colnames(data_raw)[1:2] <- c("division", "variable")

data_raw <- data_raw[-c(1,2), ]

unemp_lux <- data_raw %>%
  map_df(function(x)(gsub(",", ".", x = x))) %>%
  mutate_at(vars(matches("\\d{4}")), as.numeric) %>%
  gather(key=year, value, -division, -variable) %>%
  spread(variable, value) %>%
  clean_names()
```

```{r, include = FALSE}
unemp_lux <- read.csv("unemployment_lux.csv", header = TRUE)
```

```{r}
head(unemp_lux)
```

Once you have the unemployment data, install the next packages you'll need to follow:

```{r, eval=FALSE}
install.packages(
  c(
    "maptools", # For gpclibPermit()
    "broom",    # For tidy()
    "ggplot2",  # To create a basic map
    "ggiraph",  # To create an interactive map
    "ggthemes", # To change the theme of the map
    )
```

There's a final package to install, but you have to get it from Github (and thus need `devtools`):

```{r, eval=FALSE}
devtools::install_github("dgrtwo/gganimate")
```

To draw a map, you will need a so-called shapefile. These files contain the geometry of the countries, regions, etc so that
it is possible to plot them. The shapefile can be obtained [here](https://data.public.lu/en/datasets/limites-administratives-du-grand-duche-de-luxembourg/).

Download the zip, and look for the file called `LIMADM_COMMUNES.shp`, which contains the geometry of the Luxembourgish communes.

```{r, include=FALSE}
library(broom)
library(dplyr)
library(purrr)
library(ggplot2)
library(maptools)
library(ggiraph)
library(ggthemes)
library(gganimate)
```

```{r, eval=FALSE}
library(broom)
library(dplyr)
library(purrr)
library(ggplot2)
library(maptools)
library(rgdal)
library(ggiraph)
library(ggthemes)
library(gganimate)
```

```{r}
getwd()
#communes <- rgdal::readOGR("LIMADM_COMMUNES.shp")

# communes_df <- broom::tidy(communes, region = "COMMUNE")
# 
# setdiff(unemp_lux$division, communes_df$id)
# 
# unemp_lux %>%
#   filter(!grepl("Canton", division), division != "Grand Duchy of Luxembourg") %>%
#   select(commune = division, year, unemp_rate = unemployment_rate_in_percent)  -> unemp_lux2
# 
# unemp_lux2$commune <- gsub("Haute-Sûre", "Haute Sûre", unemp_lux2$commune)
# 
# communes_df$id2 <- gsub("Redange", "Redange-sur-Attert", communes_df$id)
# communes_df$group2 <- gsub("Redange", "Redange-sur-Attert", communes_df$group)
# 
# 
# communes_df %>%
#   select(long, lat, commune = id2, group = group2) -> communes_df2
# 
# 
# setdiff(unemp_lux2$commune, communes_df2$commune)
# 
# final_data <- left_join(communes_df2, unemp_lux2, by = "commune")
# 
# final_data2001 <- final_data %>%
#   filter(year == 2001)
# 
# ggplot_map <- ggplot() +
#   geom_polygon(data = final_data2001,
#             aes(x = long, y = lat, group = commune, fill = unemp_rate))
# 
# print(ggplot_map)
```